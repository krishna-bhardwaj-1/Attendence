<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Portal - Smart Attendance</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/style/studentportal.css">
    <style>
        #cameraContainer {
            position: relative;
            background: #000;
            border-radius: 12px;
            overflow: hidden;
            width: 100%;
            aspect-ratio: 16 / 9;
        }

        #cameraVideo {
            width: 100%;
            height: 100%;
            display: block;
            transform: scaleX(-1);
            object-fit: cover;
        }

        .camera-status {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.7);
            color: #4caf50;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .camera-status.error {
            color: #ff6b6b;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: currentColor;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .camera-placeholder {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100%;
            color: #999;
            gap: 10px;
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <div class="logo-section">
                <div class="logo-icon">
                    <i class="fas fa-brain"></i>
                </div>
                <div class="header-title">
                    <h1>Smart Attendance</h1>
                    <p>"Your gateway to seamless attendance tracking"</p>
                </div>
            </div>
            
            <div class="user-info">
                <h3>Welcome, {{student.name}}</h3>
                <div class="user-details">
                    <span><i class="fas fa-id-card"></i> {{student.rollNumber}}</span>
                    <span><i class="fas fa-graduation-cap"></i>{{student.course}}</span>
                    <span><i class="fas fa-calendar-alt"></i> Year {{student.year}}</span>
                    <span><i class="fas fa-check-circle"></i> Sem {{student.semester}}</span>
                </div>
            </div>
            <div class="user-actions">
                <a href="/" class="action-btn logout-btn">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </a>
            </div>
        </div>
    </header>

    <div class="main-container">
        <!-- Left Sidebar - Today's Classes -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h2>Today's Schedule</h2>
                <div class="current-date" id="currentDate"></div>
            </div>
            
            <div class="class-list">
                <div class="class-item" data-subject="{{timetable.class1.subjectName}}" data-time="{{timetable.class1.timing}}" data-room="{{timetable.class1.roomNo}}">
                    <div class="class-time">{{timetable.class1.timing}}</div>
                    <div class="class-subject">{{timetable.class1.subjectName}}</div>
                    <div class="class-location">
                        <i class="fas fa-map-marker-alt"></i>{{timetable.class1.roomNo}}
                    </div>
                </div>
                <div class="class-item" data-subject="{{timetable.class2.subjectName}}" data-time="{{timetable.class2.timing}}" data-room="{{timetable.class2.roomNo}}">
                    <div class="class-time">{{timetable.class2.timing}}</div>
                    <div class="class-subject">{{timetable.class2.subjectName}}</div>
                    <div class="class-location">
                        <i class="fas fa-map-marker-alt"></i>{{timetable.class2.roomNo}}
                    </div>
                </div>
                <div class="class-item" data-subject="{{timetable.class3.subjectName}}" data-time="{{timetable.class3.timing}}" data-room="{{timetable.class3.roomNo}}">
                    <div class="class-time">{{timetable.class3.timing}}</div>
                    <div class="class-subject">{{timetable.class3.subjectName}}</div>
                    <div class="class-location">
                        <i class="fas fa-map-marker-alt"></i>{{timetable.class3.roomNo}}
                    </div>
                </div>
                <div class="class-item" data-subject="{{timetable.class4.subjectName}}" data-time="{{timetable.class4.timing}}" data-room="{{timetable.class4.roomNo}}">
                    <div class="class-time">{{timetable.class4.timing}}</div>
                    <div class="class-subject">{{timetable.class4.subjectName}}</div>
                    <div class="class-location">
                        <i class="fas fa-map-marker-alt"></i>{{timetable.class4.roomNo}}
                    </div>
                </div>
                <div class="class-item" data-subject="{{timetable.class5.subjectName}}" data-time="{{timetable.class5.timing}}" data-room="{{timetable.class5.roomNo}}">
                    <div class="class-time">{{timetable.class5.timing}}</div>
                    <div class="class-subject">{{timetable.class5.subjectName}}</div>
                    <div class="class-location">
                        <i class="fas fa-map-marker-alt"></i>{{timetable.class5.roomNo}}
                    </div>
                </div>
                <div class="class-item" data-subject="{{timetable.class6.subjectName}}" data-time="{{timetable.class6.timing}}" data-room="{{timetable.class6.roomNo}}">
                    <div class="class-time">{{timetable.class6.timing}}</div>
                    <div class="class-subject">{{timetable.class6.subjectName}}</div>
                    <div class="class-location">
                        <i class="fas fa-map-marker-alt"></i>{{timetable.class6.roomNo}}
                    </div>
                </div>
            </div>
        </div>

        <div class="content-area">
            <div class="welcome-section" id="welcomeSection">
                <h2>ðŸŽ“ Welcome to Your Portal!</h2>
                <p>Select a class from your schedule to mark your attendance. Make sure to have good lighting and look directly at the camera when marking your presence. Your attendance is important for your academic progress!</p>
            </div>

            <div class="attendance-section" id="attendanceSection" style="display: none;">
                <div class="content-header">
                    <h2 id="selectedClass"></h2>
                    <p id="selectedTime"></p>
                </div>

                <!-- Attendance Status -->
                <div class="attendance-status">
                    <div class="status-info">
                        <div class="status-icon pending" id="statusIcon">
                            <i class="fas fa-clock"></i>
                        </div>
                        <div class="status-text">
                            <h3 id="statusTitle">Attendance Pending</h3>
                            <p id="statusDescription">Click "Mark Present" to start the face recognition process</p>
                        </div>
                    </div>
                    <a href="#" class="mark-present-btn disabled" id="markPresentBtn">
                        <i class="fas fa-user-check"></i>
                        Mark Present
                    </a>
                </div>

                <!-- Camera Section -->
                <div class="camera-section">
                    <div class="camera-header">
                        <div class="camera-title">Face Recognition Camera</div>
                        <div class="current-time" id="currentTime"></div>
                    </div>
                    
                    <div id="cameraContainer">
                        <div class="camera-placeholder" id="cameraPlaceholder">
                            <i class="fas fa-camera" style="font-size: 3rem;"></i>
                            <p>Click "Mark Present" to start camera</p>
                        </div>
                        <video id="cameraVideo" style="display: none;"></video>
                        <div class="camera-status" id="cameraStatus" style="display: none;">
                            <div class="status-dot"></div>
                            <span id="cameraStatusText">Camera On</span>
                        </div>
                    </div>
                    
                    <div class="camera-controls"></div>
                </div>

                <!-- Attendance Log -->
                <div class="attendance-log">
                    <div class="log-header">Recent Attendance Updates</div>
                    <div id="attendanceLog">
                        <div class="log-item">
                            <span>No recent updates</span>
                            <span>--:--</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script src="/js/student.js"></script>
    <script>
        // Camera and Face Recognition Script
        const video = document.getElementById('cameraVideo');
        const cameraContainer = document.getElementById('cameraContainer');
        const cameraPlaceholder = document.getElementById('cameraPlaceholder');
        const cameraStatus = document.getElementById('cameraStatus');
        const markPresentBtn = document.getElementById('markPresentBtn');
        const statusTitle = document.getElementById('statusTitle');
        const statusDescription = document.getElementById('statusDescription');
        
        let cameraStream = null;
        let isProcessing = false;

        async function startCamera() {
            try {
                console.log('Starting camera...');
                cameraPlaceholder.style.display = 'none';
                video.style.display = 'block';
                
                cameraStream = await navigator.mediaDevices.getUserMedia({
                    video: { 
                        width: { ideal: 1280 },
                        height: { ideal: 720 },
                        facingMode: 'user'
                    },
                    audio: false
                });

                video.srcObject = cameraStream;
                video.onloadedmetadata = () => {
                    video.play();
                };
                
                cameraStatus.style.display = 'flex';
                
                console.log('Camera started successfully');
                return true;
                
            } catch (error) {
                console.error('Camera error:', error);
                video.style.display = 'none';
                cameraPlaceholder.innerHTML = `
                    <i class="fas fa-camera-slash" style="font-size: 3rem; color: #ff6b6b;"></i>
                    <p>Camera access denied or not available</p>
                    <p style="font-size: 12px;">Error: ${error.message}</p>
                `;
                cameraPlaceholder.style.display = 'flex';
                return false;
            }
        }

        function stopCamera() {
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
                cameraStream = null;
            }
            video.style.display = 'none';
            cameraStatus.style.display = 'none';
            cameraPlaceholder.style.display = 'flex';
        }

        // Override mark present to start camera and recognition
        markPresentBtn.addEventListener('click', async function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            if (this.classList.contains('disabled')) {
                alert('Please wait for teacher to enable attendance');
                return;
            }
            
            if (isProcessing) {
                alert('Face recognition already in progress');
                return;
            }
            
            isProcessing = true;
            
            // Start camera
            const cameraOk = await startCamera();
            if (!cameraOk) {
                isProcessing = false;
                return;
            }
            
            // Disable button
            this.classList.add('disabled');
            this.style.opacity = '0.5';
            this.style.cursor = 'not-allowed';
            
            // Update status
            statusTitle.textContent = 'Face Recognition in Progress';
            statusDescription.textContent = 'Look at the camera...';
            
            // Get roll number
            const rollNumberEl = document.querySelector('.user-details span:first-child');
            const rollNumber = rollNumberEl ? rollNumberEl.textContent.split(' ')[1] : '';
            
            console.log('Starting face recognition for:', rollNumber);
            
            if (rollNumber) {
                // Call backend face recognition
                const url = `/student/mark-attendence-face?rollNumber=${encodeURIComponent(rollNumber)}`;
                
                try {
                    const response = await fetch(url);
                    const html = await response.text();
                    
                    console.log('Recognition complete');
                    stopCamera();
                    
                    // Show response
                    if (response.ok) {
                        // Parse alert message from HTML
                        const match = html.match(/alert\('([^']+)'\)/);
                        if (match) {
                            alert(match[1]);
                        }
                        setTimeout(() => location.reload(), 2000);
                    } else {
                        alert('Face recognition failed');
                        this.classList.remove('disabled');
                        this.style.opacity = '1';
                        this.style.cursor = 'pointer';
                        statusTitle.textContent = 'Attendance Pending';
                        statusDescription.textContent = 'Click "Mark Present" to try again';
                    }
                } catch (error) {
                    console.error('Error:', error);
                    stopCamera();
                    alert('Error during face recognition');
                    this.classList.remove('disabled');
                    this.style.opacity = '1';
                    this.style.cursor = 'pointer';
                    statusTitle.textContent = 'Attendance Pending';
                    statusDescription.textContent = 'Click "Mark Present" to try again';
                }
            }
            
            isProcessing = false;
        });

        // Stop camera when page unloads
        window.addEventListener('beforeunload', stopCamera);
    </script>
</body>
</html>