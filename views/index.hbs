<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Attendance - Login Portal</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/style/login.css">
    <link rel="shortcut icon" href="https://i.pinimg.com/474x/35/10/fd/3510fde9ffb75ed4c651ee5e26988614.jpg" type="image/x-icon">
    <script>
        // Define function immediately in head so it's available for onclick handlers
        function showLoginForm(type) {
            console.log('showLoginForm called with type:', type);
            const cardSelection = document.getElementById('cardSelection');
            const loginForms = document.getElementById('loginForms');
            const studentForm = document.getElementById('studentForm');
            const teacherForm = document.getElementById('teacherForm');

            console.log('Elements found:', {
                cardSelection: !!cardSelection,
                loginForms: !!loginForms,
                studentForm: !!studentForm,
                teacherForm: !!teacherForm
            });

            if (!cardSelection || !loginForms || !studentForm || !teacherForm) {
                console.error('Required elements not found');
                alert('Error: Required elements not found. Please refresh the page.');
                return;
            }

            // Hide card selection
            cardSelection.style.display = 'none';
            cardSelection.style.visibility = 'hidden';
            
            // Show login forms container
            loginForms.style.display = 'block';
            loginForms.style.visibility = 'visible';

            // Show appropriate form
            if (type === 'student') {
                console.log('Showing student form');
                studentForm.style.display = 'block';
                studentForm.style.visibility = 'visible';
                teacherForm.style.display = 'none';
                teacherForm.style.visibility = 'hidden';
            } else if (type === 'teacher') {
                console.log('Showing teacher form');
                studentForm.style.display = 'none';
                studentForm.style.visibility = 'hidden';
                teacherForm.style.display = 'block';
                teacherForm.style.visibility = 'visible';
                // Reset teacher forms - will be handled by body script override
            }
            
            console.log('Form display updated');
        }
        
        // Define showCardSelection function
        function showCardSelection() {
            const cardSelection = document.getElementById('cardSelection');
            const loginForms = document.getElementById('loginForms');
            const studentForm = document.getElementById('studentForm');
            const teacherForm = document.getElementById('teacherForm');

            if (!cardSelection || !loginForms || !studentForm || !teacherForm) {
                console.error('Required elements not found for showCardSelection');
                return;
            }

            // Hide forms
            studentForm.style.display = 'none';
            teacherForm.style.display = 'none';
            loginForms.style.display = 'none';
            loginForms.style.visibility = 'hidden';

            // Show card selection
            cardSelection.style.display = 'block';
            cardSelection.style.visibility = 'visible';
            
            // Reset teacher forms if function exists
            if (typeof resetTeacherForms === 'function') {
                resetTeacherForms();
            }
        }
        
        // Make available globally
        window.showLoginForm = showLoginForm;
        window.showCardSelection = showCardSelection;
        console.log('showLoginForm defined in head:', typeof window.showLoginForm);
        console.log('showCardSelection defined in head:', typeof window.showCardSelection);
    </script>
</head>
<body>
    <div class="main-container">
        <div class="header">
            <h1><i class="fas fa-brain"></i>Smart Attendance</h1>
            <p>"Eliminate the hassle, empower your educators"</p>
        </div>

        <!-- Card Selection View -->
        <div class="card-selection" id="cardSelection">
            <div class="selection-cards">
                <!-- Student Card -->
                <div class="selection-card student-card" onclick="showLoginForm('student'); return false;">
                    <div class="card-glow student-glow"></div>
                    <div class="card-content">
                        <div class="card-icon">
                            <i class="fas fa-graduation-cap"></i>
                        </div>
                        <h2 class="card-title">Student Portal</h2>
                        <p class="card-description">Access your attendance portal and mark your presence</p>
                        <div class="card-arrow">
                            <i class="fas fa-arrow-right"></i>
                        </div>
                    </div>
                </div>

                <!-- Teacher Card -->
                <div class="selection-card teacher-card" onclick="showLoginForm('teacher'); return false;">
                    <div class="card-glow teacher-glow"></div>
                    <div class="card-content">
                        <div class="card-icon">
                            <i class="fas fa-chalkboard-teacher"></i>
                        </div>
                        <h2 class="card-title">Educator Portal</h2>
                        <p class="card-description">Manage classes and track student attendance</p>
                        <div class="card-arrow">
                            <i class="fas fa-arrow-right"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Login Forms View -->
        <div class="login-forms" id="loginForms" style="display: none;">
            <!-- Student Login Form -->
            <div class="login-form-container student-form" id="studentForm" style="display: none;">
                <button class="back-btn" onclick="showCardSelection()">
                    <i class="fas fa-arrow-left"></i> Back
                </button>
                <div class="portal">
                    <div class="portal-header">
                        <div class="portal-icon">
                            <i class="fas fa-graduation-cap"></i>
                        </div>
                        <h2 class="portal-title">Student Portal</h2>
                    </div>
                    
                    <form class="portal-form" method="POST" action="/student/portal" autocomplete="off">
                        <div class="input-group">
                            <div class="input-container">
                                <input type="text" name="rollNumber" class="form-input" placeholder="University Roll No." required>
                                <i class="fas fa-id-card input-icon"></i>
                            </div>
                        </div>
                        
                        <div class="input-group">
                            <div class="input-container">
                                <input type="text" name="name" class="form-input" placeholder="Full Name" required>
                                <i class="fas fa-user input-icon"></i>
                            </div>
                        </div>
                        
                        <button type="submit" class="portal-btn" id="student-access-btn">
                            <i class="fas fa-sign-in-alt"></i> Access Portal
                        </button>
                    </form>

                    <div class="signup-section">
                        <p class="signup-text">Not registered yet?</p>
                        <a href="/student/signup" class="signup-btn">
                            <i class="fas fa-user-plus"></i> Sign Up
                        </a>
                    </div>
                </div>
            </div>

            <!-- Teacher Login Form -->
            <div class="login-form-container teacher-form" id="teacherForm" style="display: none;">
                <button class="back-btn" onclick="showCardSelection()">
                    <i class="fas fa-arrow-left"></i> Back
                </button>
                <div class="portal">
                    <div class="portal-header">
                        <div class="portal-icon">
                            <i class="fas fa-chalkboard-teacher"></i>
                        </div>
                        <h2 class="portal-title">Educator Portal</h2>
                    </div>
                    
                    <!-- Login Form (Step 1) -->
                    <form class="portal-form" id="teacherLoginForm" autocomplete="off" onsubmit="return false;">                    
                        <div class="input-group">
                            <div class="input-container">
                                <input type="text" name="teacherId" id="teacherId" class="form-input" placeholder="Teacher ID" required>
                                <i class="fas fa-id-badge input-icon"></i>
                            </div>
                        </div>
                        
                        <div class="input-group">
                            <div class="input-container">
                                <input type="password" name="password" id="teacherPassword" class="form-input" placeholder="Password" required>
                                <i class="fas fa-lock input-icon"></i>
                            </div>
                        </div>
                        
                        <button type="submit" class="portal-btn" id="teacher-access-btn">
                            <i class="fas fa-sign-in-alt"></i> Access Dashboard
                        </button>
                    </form>

                    <!-- OTP Form (Step 2) -->
                    <form class="portal-form" id="teacherOTPForm" style="display: none; visibility: hidden;" autocomplete="off" onsubmit="return false;">
                        <div class="otp-info" style="
                            background: rgba(0, 212, 170, 0.1);
                            border: 1px solid rgba(0, 212, 170, 0.3);
                            border-radius: 12px;
                            padding: 20px;
                            margin-bottom: 25px;
                            text-align: center;
                        ">
                            <i class="fas fa-envelope" style="font-size: 2rem; color: #00d4aa; margin-bottom: 10px;"></i>
                            <p style="color: var(--text-primary); font-weight: 600; margin-bottom: 8px;">OTP Sent!</p>
                            <p style="color: var(--text-secondary); font-size: 0.9rem;" id="otpEmailDisplay">Check your email for the OTP</p>
                        </div>
                        
                        <div class="input-group">
                            <div class="input-container">
                                <input type="text" name="otp" id="teacherOTP" class="form-input" placeholder="Enter 6-digit OTP" maxlength="6" pattern="[0-9]{6}" inputmode="numeric" required>
                                <i class="fas fa-key input-icon"></i>
                            </div>
                        </div>
                        
                        <button type="submit" class="portal-btn" id="teacher-verify-btn">
                            <i class="fas fa-check-circle"></i> Verify OTP
                        </button>
                        
                        <div style="text-align: center; margin-top: 20px;">
                            <button type="button" class="resend-otp-btn" id="resendOTPBtn" onclick="resendOTP()" style="
                                background: transparent;
                                border: none;
                                color: var(--accent-primary);
                                cursor: pointer;
                                font-size: 0.9rem;
                                text-decoration: underline;
                            ">
                                Resend OTP
                            </button>
                        </div>
                    </form>

                    <div class="signup-section">
                        <p class="signup-text">Need an account?</p>
                        <a href="/teacher/register" class="signup-btn">
                            <i class="fas fa-user-plus"></i> Register
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let teacherCredentials = {};

        // showLoginForm is already defined in head, so we just update it to include resetTeacherForms
        // Override the head version to include resetTeacherForms functionality
        const originalShowLoginForm = window.showLoginForm;
        window.showLoginForm = function(type) {
            originalShowLoginForm(type);
            // If teacher form, reset teacher forms
            if (type === 'teacher' && typeof resetTeacherForms === 'function') {
                resetTeacherForms();
            }
        };

        // showCardSelection is already defined in head, just update it if needed
        if (window.showCardSelection) {
            const originalShowCardSelection = window.showCardSelection;
            window.showCardSelection = function() {
                originalShowCardSelection();
                // Reset teacher forms if function exists
                if (typeof resetTeacherForms === 'function') {
                    resetTeacherForms();
                }
            };
        }

        function resetTeacherForms() {
            const loginForm = document.getElementById('teacherLoginForm');
            const otpForm = document.getElementById('teacherOTPForm');
            
            if (loginForm) loginForm.style.display = 'block';
            if (otpForm) otpForm.style.display = 'none';
            
            teacherCredentials = {};
        }

        // Test function availability
        console.log('showLoginForm function available:', typeof window.showLoginForm);
        console.log('showCardSelection function available:', typeof window.showCardSelection);

        // Handle teacher login form submission
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM Content Loaded - Setting up event listeners');
            
            // Add click event listeners to cards
            const studentCard = document.querySelector('.student-card');
            const teacherCard = document.querySelector('.teacher-card');
            
            console.log('Student card found:', !!studentCard);
            console.log('Teacher card found:', !!teacherCard);
            
            if (studentCard) {
                studentCard.style.cursor = 'pointer';
                // Remove any existing listeners and add new one
                studentCard.onclick = function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('Student card clicked - onclick handler');
                    showLoginForm('student');
                    return false;
                };
                // Also add event listener as backup
                studentCard.addEventListener('click', function(e) {
                    console.log('Student card clicked - event listener');
                    showLoginForm('student');
                }, true);
            } else {
                console.error('Student card not found');
            }
            
            if (teacherCard) {
                teacherCard.style.cursor = 'pointer';
                // Remove any existing listeners and add new one
                teacherCard.onclick = function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('Teacher card clicked - onclick handler');
                    showLoginForm('teacher');
                    return false;
                };
                // Also add event listener as backup
                teacherCard.addEventListener('click', function(e) {
                    console.log('Teacher card clicked - event listener');
                    showLoginForm('teacher');
                }, true);
            } else {
                console.error('Teacher card not found');
            }
            
            const teacherLoginForm = document.getElementById('teacherLoginForm');
            const teacherOTPForm = document.getElementById('teacherOTPForm');
            
            if (teacherLoginForm) {
                // Prevent default form submission
                teacherLoginForm.onsubmit = function(e) {
                    e.preventDefault();
                    return false;
                };
                
                teacherLoginForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    e.stopImmediatePropagation();
                    
                    console.log('Teacher login form submitted');
                    
                    const teacherId = document.getElementById('teacherId').value.trim();
                    const password = document.getElementById('teacherPassword').value;
                    const submitBtn = document.getElementById('teacher-access-btn');
                    
                    if (!teacherId || !password) {
                        alert('Please enter both teacher ID and password');
                        return false;
                    }
                    
                    // Store credentials for resend
                    teacherCredentials = { teacherId, password };
                    
                    // Disable button
                    if (submitBtn) {
                        submitBtn.disabled = true;
                        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sending OTP...';
                    }
                    
                    try {
                        console.log('Sending request to /teacher/portal with:', { teacherId, password: '***' });
                        
                        const response = await fetch('/teacher/portal', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({ teacherId, password }),
                            credentials: 'same-origin' // Include cookies/session
                        });
                        
                        console.log('Response status:', response.status);
                        console.log('Response headers:', response.headers);
                        
                        // Check if response is JSON
                        const contentType = response.headers.get('content-type');
                        console.log('Content-Type:', contentType);
                        
                        if (!contentType || !contentType.includes('application/json')) {
                            const text = await response.text();
                            console.error('Non-JSON response:', text);
                            console.error('Response status:', response.status);
                            
                            // Check if it's a redirect
                            if (response.status === 302 || response.status === 301 || response.redirected) {
                                alert('Server redirected. Please check your credentials and try again.');
                            } else {
                                alert('Server error: ' + (text.substring(0, 100) || 'Invalid response'));
                            }
                            
                            if (submitBtn) {
                                submitBtn.disabled = false;
                                submitBtn.innerHTML = '<i class="fas fa-sign-in-alt"></i> Access Dashboard';
                            }
                            return false;
                        }
                        
                        const data = await response.json();
                        console.log('Response data:', data);
                        
                        if (data.success) {
                            console.log('OTP sent successfully, showing OTP form');
                            
                            // Hide login form, show OTP form
                            if (teacherLoginForm) {
                                teacherLoginForm.style.display = 'none';
                                teacherLoginForm.style.visibility = 'hidden';
                            }
                            if (teacherOTPForm) {
                                teacherOTPForm.style.display = 'block';
                                teacherOTPForm.style.visibility = 'visible';
                                console.log('OTP form is now visible');
                            } else {
                                console.error('teacherOTPForm element not found!');
                            }
                            
                            // Display masked email
                            const emailDisplay = document.getElementById('otpEmailDisplay');
                            if (emailDisplay && data.email) {
                                emailDisplay.textContent = `OTP sent to ${data.email}`;
                            }
                            
                            // Focus on OTP input and add input validation
                            setTimeout(() => {
                                const otpInput = document.getElementById('teacherOTP');
                                if (otpInput) {
                                    otpInput.focus();
                                    otpInput.value = ''; // Clear any previous value
                                    
                                    // Only allow numbers in OTP input
                                    otpInput.addEventListener('input', function(e) {
                                        e.target.value = e.target.value.replace(/[^0-9]/g, '');
                                    }, { once: false });
                                } else {
                                    console.error('OTP input not found!');
                                }
                            }, 100);
                            
                            // Clear URL parameters
                            window.history.replaceState({}, document.title, window.location.pathname);
                        } else {
                            alert(data.message || 'Failed to send OTP. Please try again.');
                            if (submitBtn) {
                                submitBtn.disabled = false;
                                submitBtn.innerHTML = '<i class="fas fa-sign-in-alt"></i> Access Dashboard';
                            }
                        }
                    } catch (error) {
                        console.error('Error in form submission:', error);
                        console.error('Error stack:', error.stack);
                        alert('An error occurred: ' + error.message);
                        if (submitBtn) {
                            submitBtn.disabled = false;
                            submitBtn.innerHTML = '<i class="fas fa-sign-in-alt"></i> Access Dashboard';
                        }
                    }
                    
                    return false;
                }, true); // Use capture phase
            } else {
                console.error('teacherLoginForm not found!');
            }
            
            // Handle OTP form submission
            if (teacherOTPForm) {
                // Prevent default form submission
                teacherOTPForm.onsubmit = function(e) {
                    e.preventDefault();
                    return false;
                };
                
                teacherOTPForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    e.stopImmediatePropagation();
                    
                    console.log('OTP form submitted');
                    
                    const otpInput = document.getElementById('teacherOTP');
                    const otp = otpInput ? otpInput.value.trim() : '';
                    const verifyBtn = document.getElementById('teacher-verify-btn');
                    
                    // Validate OTP (only numbers, 6 digits)
                    if (!/^\d{6}$/.test(otp)) {
                        alert('Please enter a valid 6-digit OTP (numbers only)');
                        if (otpInput) otpInput.focus();
                        return false;
                    }
                    
                    // Disable button
                    if (verifyBtn) {
                        verifyBtn.disabled = true;
                        verifyBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Verifying...';
                    }
                    
                    try {
                        console.log('Sending OTP verification request');
                        
                        const response = await fetch('/teacher/verify-otp', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({ otp }),
                            credentials: 'same-origin' // Include cookies/session
                        });
                        
                        console.log('OTP verification response status:', response.status);
                        
                        const contentType = response.headers.get('content-type');
                        
                        if (contentType && contentType.includes('text/html')) {
                            // Server rendered the portal page - replace current page
                            console.log('Server returned HTML, replacing page');
                            const html = await response.text();
                            document.open();
                            document.write(html);
                            document.close();
                            return false;
                        }
                        
                        const data = await response.json();
                        console.log('OTP verification response:', data);
                        
                        if (data.success) {
                            // OTP verified - redirect to portal
                            console.log('OTP verified successfully, redirecting to portal');
                            if (verifyBtn) {
                                verifyBtn.innerHTML = '<i class="fas fa-check-circle"></i> Verified! Redirecting...';
                            }
                            
                            // Small delay to show success message, then redirect
                            setTimeout(() => {
                                window.location.href = '/teacher/portal';
                            }, 500);
                        } else {
                            alert(data.message || 'Invalid OTP. Please try again.');
                            if (verifyBtn) {
                                verifyBtn.disabled = false;
                                verifyBtn.innerHTML = '<i class="fas fa-check-circle"></i> Verify OTP';
                            }
                            if (otpInput) {
                                otpInput.value = '';
                                otpInput.focus();
                            }
                        }
                    } catch (error) {
                        console.error('Error in OTP verification:', error);
                        alert('An error occurred: ' + error.message);
                        if (verifyBtn) {
                            verifyBtn.disabled = false;
                            verifyBtn.innerHTML = '<i class="fas fa-check-circle"></i> Verify OTP';
                        }
                    }
                    
                    return false;
                }, true);
            } else {
                console.error('teacherOTPForm not found!');
            }
            
            // Check for URL parameters and auto-fill/submit form (after event listeners are set up)
            const urlParams = new URLSearchParams(window.location.search);
            const teacherId = urlParams.get('teacherId');
            const password = urlParams.get('password');
            
            if (teacherId && password) {
                console.log('URL parameters found:', { teacherId, password: '***' });
                // Show teacher form
                showLoginForm('teacher');
                
                // Wait a bit for form to be visible, then pre-fill
                setTimeout(() => {
                    const teacherIdInput = document.getElementById('teacherId');
                    const passwordInput = document.getElementById('teacherPassword');
                    
                    if (teacherIdInput) {
                        teacherIdInput.value = decodeURIComponent(teacherId);
                    }
                    if (passwordInput) {
                        passwordInput.value = decodeURIComponent(password);
                    }
                    
                    // Auto-submit after form is filled and event listeners are attached
                    setTimeout(() => {
                        const teacherLoginForm = document.getElementById('teacherLoginForm');
                        if (teacherLoginForm) {
                            console.log('Auto-submitting teacher login form');
                            // Create and dispatch submit event
                            const submitEvent = new Event('submit', { bubbles: true, cancelable: true });
                            teacherLoginForm.dispatchEvent(submitEvent);
                        }
                    }, 300);
                }, 200);
            }
        });

        // Resend OTP function
        async function resendOTP() {
            if (!teacherCredentials.teacherId || !teacherCredentials.password) {
                alert('Please login again');
                return;
            }
            
            const resendBtn = document.getElementById('resendOTPBtn');
            resendBtn.disabled = true;
            resendBtn.textContent = 'Sending...';
            
            try {
                const response = await fetch('/teacher/portal', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(teacherCredentials)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert('OTP resent successfully! Please check your email.');
                    const emailDisplay = document.getElementById('otpEmailDisplay');
                    if (emailDisplay && data.email) {
                        emailDisplay.textContent = `OTP sent to ${data.email}`;
                    }
                } else {
                    alert(data.message || 'Failed to resend OTP. Please try again.');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('An error occurred. Please try again.');
            } finally {
                resendBtn.disabled = false;
                resendBtn.textContent = 'Resend OTP';
            }
        }
    </script>
</body>
</html>